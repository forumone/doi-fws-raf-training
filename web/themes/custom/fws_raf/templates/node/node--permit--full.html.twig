{#
/**
 * @file
 * Custom theme implementation to present permit data.
 *
 * This template overrides the default node.html.twig template specifically for
 * the permit node type to display fields from the permit entity, grouped logically.
 *
 * Available variables:
 * - content: A list of content items. Use 'content' to print all content, or
 *   print a subset such as 'content.field_example'. Fields should be rendered
 *   directly, e.g., {{ content.field_example }}.
 * - attributes: HTML attributes for the container element.
 * - node: A Drupal Node entity. Generally, prefer 'content' for field rendering.
 * - locations: An array of location nodes related to this permit (if available
 *   from preprocessing).
 * - agents: An array of name nodes related to this permit (if available from
 *   preprocessing).
 *
 * @see template_preprocess_node()
 */
#}

{% set classes = [
  'registration-form',
  'permit-node-display',
  'clearfix',
] %}

<article{{ attributes.addClass(classes) }} style="margin-bottom: 22px;">

  {# Permit Approval Status Message #}
  {% if content.field_permit_status_cd is defined and content.field_permit_status_cd|render matches '/APPROVED/i' %}
    <div class="alert alert-success">
      <strong>This permit has been approved.</strong> Please check the expiration date for validity information.
    </div>
  {% endif %}

  {# Certification Form Section #}
  {% set is_certified = content.field_applicant_signed is defined and content.field_applicant_signed|render|striptags|trim == '1' %}
  <div class="panel panel-primary mt-3">
    <div class="panel-heading">
      <h3 class="panel-title">Registrant Certification</h3>
    </div>
    <div class="panel-body">
      <p>I certify that the information in this report is true and correct to the best of my knowledge. I understand that any false statement herein may subject me to the criminal penalties of 18 U.S.C. 1001.</p>

      {% if not is_certified %}
        {{ drupal_block('certification_form_block', wrapper=false) }}
      {% else %}
        <div class="alert alert-success">
          <strong>This permit has been certified.</strong> Your registration is complete.
          {% if content.field_dt_applicant_signed is defined %}
            <p>Certified on: {{ content.field_dt_applicant_signed }}</p>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  {# Panel 1: Permit Information #}
  <div class="panel panel-primary mt-3">
    <div class="panel-heading">
      <h3 class="panel-title">Permit Information</h3>
    </div>
    <div class="panel-body">
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <tbody>
            {% if content.field_permit_no %}<tr><th class="col-md-3">Permit No.</th><td class="col-md-9">{{ content.field_permit_no }}</td></tr>{% endif %}
            {% if content.field_permit_status_cd %}<tr><th class="col-md-3">Status</th><td class="col-md-9">{{ content.field_permit_status_cd }}</td></tr>{% endif %}
            {% if content.field_permit_type_cd %}<tr><th class="col-md-3">Permit Type</th><td class="col-md-9">{{ content.field_permit_type_cd }}</td></tr>{% endif %}
            <tr>
              <th class="col-md-3">Date Created</th>
              <td class="col-md-9">
                {% if content.field_dt_create %}
                  {{ content.field_dt_create }}
                {% else %}
                  {{ node.created.value|date('n/j/Y') }}
                {% endif %}
              </td>
            </tr>
            <tr><th class="col-md-3">Date Updated</th><td class="col-md-9">{{ node.changed.value|date('n/j/Y') }}</td></tr>
            {% if content.field_dt_permit_issued %}<tr><th class="col-md-3">Permit Issued Date</th><td class="col-md-9">{{ content.field_dt_permit_issued }}</td></tr>{% endif %}
            {% if content.field_dt_effective %}<tr><th class="col-md-3">Effective Date</th><td class="col-md-9">{{ content.field_dt_effective }}</td></tr>{% endif %}
            {% if content.field_dt_expired %}<tr><th class="col-md-3">Expiry Date</th><td class="col-md-9">{{ content.field_dt_expired }}</td></tr>{% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# Panel 2: Applicant Identification #}
  <div class="panel panel-primary mt-3">
    <div class="panel-heading">
      <h3 class="panel-title">Applicant Identification</h3>
    </div>
    <div class="panel-body">
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <tbody>
            <tr>
              <th class="col-md-3">Applicant Name</th>
              <td class="col-md-9">
                {% if content.field_applicant_business_name is defined and content.field_applicant_business_name|render|striptags|trim %}
                  {{ content.field_applicant_business_name }}
                {% elseif content.field_applicant_last_name or content.field_applicant_first_name %}
                  {% set name_parts = [] %}
                  {% if content.field_applicant_prefix %}{% set name_parts = name_parts|merge([content.field_applicant_prefix|render|striptags|trim]) %}{% endif %}
                  {% if content.field_applicant_first_name %}{% set name_parts = name_parts|merge([content.field_applicant_first_name|render|striptags|trim]) %}{% endif %}
                  {% if content.field_applicant_middle_name %}{% set name_parts = name_parts|merge([content.field_applicant_middle_name|render|striptags|trim]) %}{% endif %}
                  {% if content.field_applicant_last_name %}{% set name_parts = name_parts|merge([content.field_applicant_last_name|render|striptags|trim]) %}{% endif %}
                  {% if content.field_applicant_suffix %}{% set name_parts = name_parts|merge([content.field_applicant_suffix|render|striptags|trim]) %}{% endif %}
                  {{ name_parts|join(' ') }}
                {% else %}
                  N/A
                {% endif %}
              </td>
            </tr>
            {% if content.field_applicant_business_name %}<tr><th class="col-md-3">Business Name</th><td class="col-md-9">{{ content.field_applicant_business_name }}</td></tr>{% endif %}
            {% if content.field_applicant_business_desc %}<tr><th class="col-md-3">Business Description</th><td class="col-md-9">{{ content.field_applicant_business_desc }}</td></tr>{% endif %}
            {% if content.field_registrant_type_cd %}<tr><th class="col-md-3">Applicant Type</th><td class="col-md-9">{{ content.field_registrant_type_cd }}</td></tr>{% endif %}
            {% if content.field_bi_cd %}<tr><th class="col-md-3">BI Code</th><td class="col-md-9">{{ content.field_bi_cd }}</td></tr>{% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# Panel 3: Applicant Address and Contact #}
  <div class="panel panel-primary mt-3">
    <div class="panel-heading">
      <h3 class="panel-title">Applicant Address and Contact</h3>
    </div>
    <div class="panel-body">
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <tbody>
            {% if content.field_applicant_address_l1 or content.field_applicant_address_l2 or content.field_applicant_address_l3 %}
            <tr><th class="col-md-3">Address</th>
                <td class="col-md-9">
                  {% if content.field_applicant_address_l1 %}<div>{{ content.field_applicant_address_l1 }}</div>{% endif %}
                  {% if content.field_applicant_address_l2 %}<div>{{ content.field_applicant_address_l2 }}</div>{% endif %}
                  {% if content.field_applicant_address_l3 %}<div>{{ content.field_applicant_address_l3 }}</div>{% endif %}
                </td>
            </tr>
            {% endif %}
            {% if content.field_applicant_city %}<tr><th class="col-md-3">City</th><td class="col-md-9">{{ content.field_applicant_city }}</td></tr>{% endif %}
            {% if content.field_applicant_county %}<tr><th class="col-md-3">County</th><td class="col-md-9">{{ content.field_applicant_county }}</td></tr>{% endif %}
            {% if content.field_applicant_state %}<tr><th class="col-md-3">State</th><td class="col-md-9">{{ content.field_applicant_state }}</td></tr>{% endif %}
            {% if content.field_applicant_zip %}<tr><th class="col-md-3">ZIP Code</th><td class="col-md-9">{{ content.field_applicant_zip }}</td></tr>{% endif %}
            {% if content.field_applicant_home_phone %}<tr><th class="col-md-3">Home Phone</th><td class="col-md-9">{{ content.field_applicant_home_phone }}</td></tr>{% endif %}
            {% if content.field_applicant_work_phone %}<tr><th class="col-md-3">Work Phone</th><td class="col-md-9">{{ content.field_applicant_work_phone }}</td></tr>{% endif %}
            {% if content.field_applicant_email_address %}<tr><th class="col-md-3">Email</th><td class="col-md-9">{{ content.field_applicant_email_address }}</td></tr>{% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# Panel 4: Principal Information (Conditional) #}
  {% set is_business = content.field_registrant_type_cd is defined and content.field_registrant_type_cd|render matches '/Business/i' %}
  {% if is_business %}
    <div class="panel panel-primary mt-3">
      <div class="panel-heading">
        <h3 class="panel-title">Principal Information</h3>
      </div>
      <div class="panel-body">
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <tbody>
              {% if content.field_principal_name %}<tr><th class="col-md-3">Principal Name</th><td class="col-md-9">{{ content.field_principal_name }}</td></tr>{% endif %}
              {% if content.field_principal_first_name %}<tr><th class="col-md-3">Principal First Name</th><td class="col-md-9">{{ content.field_principal_first_name }}</td></tr>{% endif %}
              {% if content.field_principal_middle_name %}<tr><th class="col-md-3">Principal Middle Name</th><td class="col-md-9">{{ content.field_principal_middle_name }}</td></tr>{% endif %}
              {% if content.field_principal_last_name %}<tr><th class="col-md-3">Principal Last Name</th><td class="col-md-9">{{ content.field_principal_last_name }}</td></tr>{% endif %}
              {% if content.field_principal_suffix %}<tr><th class="col-md-3">Principal Suffix</th><td class="col-md-9">{{ content.field_principal_suffix }}</td></tr>{% endif %}
              {% if content.field_principal_title %}<tr><th class="col-md-3">Principal Title</th><td class="col-md-9">{{ content.field_principal_title }}</td></tr>{% endif %}
              {% if content.field_principal_telephone %}<tr><th class="col-md-3">Principal Telephone</th><td class="col-md-9">{{ content.field_principal_telephone }}</td></tr>{% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  {# NEW Panel: Primary Contact (Conditional) #}
  {% if is_business %}
    <div class="panel panel-primary mt-3">
      <div class="panel-heading">
        <h3 class="panel-title">Primary Contact Information</h3>
      </div>
      <div class="panel-body">
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <tbody>
              {% if content.field_primary_contact_name %}<tr><th class="col-md-3">Primary Contact Name</th><td class="col-md-9">{{ content.field_primary_contact_name }}</td></tr>{% endif %}
              {% if content.field_primary_contact_telephone %}<tr><th class="col-md-3">Primary Contact Telephone</th><td class="col-md-9">{{ content.field_primary_contact_telephone }}</td></tr>{% endif %}
              {% if content.field_primary_contact_email %}<tr><th class="col-md-3">Primary Contact Email</th><td class="col-md-9">{{ content.field_primary_contact_email }}</td></tr>{% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  {# Panel 5: Location of Properties #}
  {% if locations is defined and locations is not empty %}
    <div class="panel panel-primary mt-3">
      <div class="panel-heading">
        <h3 class="panel-title">Location of Properties</h3>
      </div>
      <div class="panel-body">
        {% set location_count = 0 %}
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th>#</th>
                <th>County</th>
                <th>Address</th>
                <th>City</th>
                <th>State</th>
                <th>ZIP</th>
              </tr>
            </thead>
            <tbody>
              {% for location in locations %}
                {% set location_count = location_count + 1 %}
                <tr>
                  <td>{{ location_count }}</td>
                  <td>{% if location.field_location_county.value %}{{ location.field_location_county.value }}{% endif %}</td>
                  <td>{% if location.field_location_address.value %}{{ location.field_location_address.value }}{% endif %}</td>
                  <td>{% if location.field_location_city.value %}{{ location.field_location_city.value }}{% endif %}</td>
                  <td>{% if location.field_location_state_ref.target_id %}{{ location.field_location_state_ref.entity.label }}{% endif %}</td>
                  <td>{% if location.field_location_zip.value %}{{ location.field_location_zip.value }}{% endif %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">
      No locations have been added yet.
      <a href="/node/add/location">Add a location</a>
    </div>
  {% endif %}

  {# Panel 6: Agent/Employee #}
  {% if agents is defined and agents is not empty %}
    <div class="panel panel-primary mt-3">
      <div class="panel-heading">
        <h3 class="panel-title">Agent/Employee</h3>
      </div>
      <div class="panel-body">
        {% set agent_count = 0 %}
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
              </tr>
            </thead>
            <tbody>
              {% for agent in agents %}
                {% set agent_count = agent_count + 1 %}
                <tr>
                  <td>{{ agent_count }}</td>
                  <td>{{ agent.label }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">
      No agents have been added yet.
      <a href="/node/add/name">Add an agent</a>
    </div>
  {% endif %}

  {# NEW Panel: Agreements #}
  <div class="panel panel-primary mt-3">
    <div class="panel-heading">
      <h3 class="panel-title">Agreements</h3>
    </div>
    <div class="panel-body">
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <tbody>
            {% if content.field_applicant_agreement1 %}<tr><th class="col-md-3">Agreement 1</th><td class="col-md-9">{{ content.field_applicant_agreement1 }}</td></tr>{% endif %}
            {% if content.field_applicant_agreement2 %}<tr><th class="col-md-3">Agreement 2</th><td class="col-md-9">{{ content.field_applicant_agreement2 }}</td></tr>{% endif %}
            {% if content.field_applicant_agreement3 %}<tr><th class="col-md-3">Agreement 3</th><td class="col-md-9">{{ content.field_applicant_agreement3 }}</td></tr>{% endif %}
            {% if content.field_applicant_signed %}<tr><th class="col-md-3">Applicant Signed (Certified)</th><td class="col-md-9">{{ content.field_applicant_signed }}</td></tr>{% endif %}
            {% if content.field_dt_applicant_signed %}<tr><th class="col-md-3">Applicant Signed Date</th><td class="col-md-9">{{ content.field_dt_applicant_signed }}</td></tr>{% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# Conditions Section (Copied directly, verify links/text) #}
  <div class="panel panel-primary mt-3">
    <div class="panel-heading">
      <h3 class="panel-title">Conditions</h3>
    </div>
    <div class="panel-body">
      <p>You and your agents or employees must comply with the <a href="/resident-canada-goose-nest-egg-depredation-order-conditions">Resident Canada Goose Nest & Egg Depredation Order Conditions</a>.</p>
      <p>If agents or employees will conduct the nest and egg work on your behalf, you may sign this registration confirmation and provide them a copy as evidence of your authorization to perform the work.</p>
      <div class="well well-sm signature-line">
        <p>Signature of Registrant (Landowner): ______________________________________________</p>
      </div>
    </div>
  </div>

  {# Optional: Link to conditions page, copied directly #}
  <div class="text-center" style="margin-top: 30px; margin-bottom: 20px;">
    <a href="/resident-canada-goose-nest-egg-depredation-order-conditions" class="">
      Proceed to Resident Canada Goose Nest &amp; Egg Depredation Order Conditions
    </a>
  </div>

</article>
